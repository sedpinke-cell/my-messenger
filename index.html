<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üí¨ –ú–æ–π –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { background-color: #f0f2f5; height: 100vh; display: flex; justify-content: center; align-items: center; }
    .auth-screen, .main-app { width: 100%; max-width: 480px; height: 90vh; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .auth-form { padding: 30px; text-align: center; }
    .auth-form h2 { margin-bottom: 20px; color: #0088cc; }
    .auth-form input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
    .auth-form button { background: #0088cc; color: white; border: none; padding: 12px 20px; margin-top: 10px; border-radius: 8px; cursor: pointer; font-size: 1rem; }
    .auth-form button:hover { background: #006699; }
    .auth-form .switch { margin-top: 20px; color: #0088cc; cursor: pointer; text-decoration: underline; }
    .main-app { display: flex; flex-direction: column; display: none; }
    .header { background: #0088cc; color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; }
    .header h3 { font-weight: 600; }
    .profile-btn { background: white; color: #0088cc; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
    .chat-area { flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #f0f2f5; }
    .message { max-width: 70%; padding: 10px 14px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; }
    .message.sent { align-self: flex-end; background: #0088cc; color: white; border-bottom-right-radius: 4px; }
    .message.received { align-self: flex-start; background: white; color: #000; border: 1px solid #e0e0e0; border-bottom-left-radius: 4px; }
    .user-name { font-weight: 600; font-size: 0.9rem; color: #0088cc; margin-bottom: 4px; }
    .input-area { display: flex; padding: 12px; background: white; border-top: 1px solid #e0e0e0; }
    .input-area input { flex: 1; padding: 10px 16px; border: 1px solid #ddd; border-radius: 24px; margin-right: 8px; }
    .input-area button { background: #0088cc; color: white; border: none; padding: 10px 16px; border-radius: 24px; cursor: pointer; }
    .friends-list { padding: 10px; background: #f8f9fa; font-size: 0.9rem; color: #555; }
    .friends-list div { margin: 4px 0; }
    .profile-screen { padding: 20px; display: none; }
    .back-btn { background: #0088cc; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-bottom: 15px; }
  </style>
</head>
<body>

  <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
  <div class="auth-screen" id="authScreen">
    <div class="auth-form" id="loginForm">
      <h2>–í—Ö–æ–¥</h2>
      <input type="text" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è @" />
      <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" />
      <button id="loginBtn">–í–æ–π—Ç–∏</button>
      <div class="switch" id="showRegister">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</div>
    </div>

    <div class="auth-form" id="registerForm" style="display: none;">
      <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
      <input type="text" id="regUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è @" />
      <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å" />
      <input type="password" id="regConfirm" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" />
      <button id="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      <div class="switch" id="showLogin">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</div>
    </div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
  <div class="main-app" id="mainApp">
    <div class="header">
      <h3>üí¨ –ß–∞—Ç</h3>
      <button class="profile-btn" id="openProfile">–ü—Ä–æ—Ñ–∏–ª—å</button>
    </div>
    <div class="friends-list">
      <strong>–î—Ä—É–∑—å—è:</strong>
      <div id="friends"></div>
      <input type="text" id="addFriendInput" placeholder="ID –¥—Ä—É–≥–∞ @" style="margin-top: 10px; padding: 8px; width: 70%;" />
      <button id="addFriendBtn" style="padding: 8px;">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div class="chat-area" id="chatArea"></div>
    <div class="input-area">
      <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
      <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
  <div class="main-app" id="profileScreen" style="display: none;">
    <div class="header">
      <h3>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h3>
      <button class="back-btn" id="backToChat">–ù–∞–∑–∞–¥</button>
    </div>
    <div class="profile-screen">
      <p><strong>–ò–º—è:</strong> <span id="profileName"></span></p>
      <p><strong>ID:</strong> <span id="profileId"></span></p>
      <p><strong>–î—Ä—É–∑–µ–π:</strong> <span id="profileFriendsCount">0</span></p>
      <button id="logoutBtn" style="margin-top: 20px; background: #dc3545; color: white; border: none; padding: 10px; border-radius: 6px;">–í—ã–π—Ç–∏</button>
    </div>
  </div>

  <script>
    // === –≠–ª–µ–º–µ–Ω—Ç—ã ===
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const showRegister = document.getElementById('showRegister');
    const showLogin = document.getElementById('showLogin');
    const loginUsername = document.getElementById('loginUsername');
    const loginPassword = document.getElementById('loginPassword');
    const regUsername = document.getElementById('regUsername');
    const regPassword = document.getElementById('regPassword');
    const regConfirm = document.getElementById('regConfirm');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const messageInput = document.getElementById('messageInput');
    const chatArea = document.getElementById('chatArea');
    const friendsList = document.getElementById('friends');
    const addFriendInput = document.getElementById('addFriendInput');
    const sendBtn = document.getElementById('sendBtn');
    const addFriendBtn = document.getElementById('addFriendBtn');
    const openProfile = document.getElementById('openProfile');
    const backToChat = document.getElementById('backToChat');
    const logoutBtn = document.getElementById('logoutBtn');
    const profileName = document.getElementById('profileName');
    const profileId = document.getElementById('profileId');
    const profileFriendsCount = document.getElementById('profileFriendsCount');
    const authScreen = document.getElementById('authScreen');
    const mainApp = document.getElementById('mainApp');
    const profileScreen = document.getElementById('profileScreen');

    let currentUser = null;
    let socket = null;
    let friends = [];

    // === –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–º ===
    if (showRegister && showLogin) {
      showRegister.addEventListener('click', () => {
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
      });

      showLogin.addEventListener('click', () => {
        registerForm.style.display = 'none';
        loginForm.style.display = 'block';
      });
    }

    // === –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ===
    registerBtn.addEventListener('click', () => {
      const username = regUsername.value.trim().replace('@', '');
      const password = regPassword.value;
      const confirm = regConfirm.value;

      if (!username || !password) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –ø–∞—Ä–æ–ª—å');
        return;
      }
      if (password !== confirm) {
        alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
        return;
      }

      fetch('/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
        } else {
          alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í–æ–π–¥–∏—Ç–µ.');
          // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –≤—Ö–æ–¥
          registerForm.style.display = 'none';
          loginForm.style.display = 'block';
        }
      })
      .catch(err => {
        console.error('–û—à–∏–±–∫–∞:', err);
        alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
      });
    });

    // === –í—Ö–æ–¥ ===
    loginBtn.addEventListener('click', () => {
      const username = loginUsername.value.trim().replace('@', '');
      const password = loginPassword.value;

      fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
        } else {
          currentUser = { name: data.name, id: data.id };
          friends = data.friends || [];
          localStorage.setItem('user', JSON.stringify(currentUser));
          localStorage.setItem('friends', JSON.stringify(friends));
          showMainApp();
          connectWebSocket();
          updateProfile();
          renderFriends();
        }
      })
      .catch(err => {
        console.error('–û—à–∏–±–∫–∞:', err);
        alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
      });
    });

    function showMainApp() {
      authScreen.style.display = 'none';
      mainApp.style.display = 'flex';
    }

    // === WebSocket ===
    function connectWebSocket() {
      socket = new WebSocket(`ws://${window.location.host}`);
      socket.onopen = () => {
        socket.send(JSON.stringify({ type: 'join', user: currentUser }));
      };
      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'chat') {
          addMessage(data.name, data.message, data.senderId === currentUser.id ? 'sent' : 'received');
        }
      };
    }

    function addMessage(name, text, type) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', type);

      if (type === 'received') {
        const nameDiv = document.createElement('div');
        nameDiv.classList.add('user-name');
        nameDiv.textContent = name;
        messageDiv.appendChild(nameDiv);
      }

      const textDiv = document.createElement('div');
      textDiv.textContent = text;
      messageDiv.appendChild(textDiv);

      chatArea.appendChild(messageDiv);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !socket) return;

      const msg = {
        type: 'chat',
        senderId: currentUser.id,
        name: currentUser.name,
        message: text
      };

      socket.send(JSON.stringify(msg));
      addMessage(currentUser.name, text, 'sent');
      messageInput.value = '';
    }

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', e => e.key === 'Enter' && sendMessage());

    // === –î—Ä—É–∑—å—è ===
    addFriendBtn.addEventListener('click', () => {
      const friendId = addFriendInput.value.trim().replace('@', '');
      if (!friendId) return;
      if (friends.includes(friendId)) {
        alert('–£–∂–µ –≤ –¥—Ä—É–∑—å—è—Ö');
        return;
      }
      friends.push(friendId);
      localStorage.setItem('friends', JSON.stringify(friends));
      renderFriends();
      updateProfile();
      addFriendInput.value = '';
    });

    function renderFriends() {
      friendsList.innerHTML = '';
      if (friends.length === 0) {
        friendsList.innerHTML = '<em>–ù–µ—Ç –¥—Ä—É–∑–µ–π</em>';
      } else {
        friends.forEach(id => {
          const div = document.createElement('div');
          div.textContent = '@' + id;
          friendsList.appendChild(div);
        });
      }
    }

    // === –ü—Ä–æ—Ñ–∏–ª—å ===
    openProfile.addEventListener('click', () => {
      mainApp.style.display = 'none';
      profileScreen.style.display = 'flex';
    });

    backToChat.addEventListener('click', () => {
      profileScreen.style.display = 'none';
      mainApp.style.display = 'flex';
    });

    function updateProfile() {
      profileName.textContent = currentUser.name;
      profileId.textContent = '@' + currentUser.id;
      profileFriendsCount.textContent = friends.length;
    }

    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('user');
      localStorage.removeItem('friends');
      location.reload();
    });

    // === –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ ===
    function checkSession() {
      const savedUser = localStorage.getItem('user');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        friends = JSON.parse(localStorage.getItem('friends') || '[]');
        showMainApp();
        connectWebSocket();
        updateProfile();
        renderFriends();
      }
    }

    checkSession();
  </script>
</body>
</html>